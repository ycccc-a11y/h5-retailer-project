# 涉企行政检查路线规划系统 - 架构设计文档

## 1. 系统概述

### 1.1 系统定位
本系统是一个基于Web的智能路线规划平台，主要用于涉企行政检查任务的路线优化与导航。系统通过整合许可证数据库、高德地图服务，实现检查点的智能排序、路线规划以及移动端导航功能。

### 1.2 核心功能
- **许可证号码搜索**：通过许可证号码快速定位企业位置
- **任务池管理**：分类管理重点检查、随机抽查、许可核查、日常检查等任务
- **智能路线规划**：基于蚁群算法优化检查点顺序，生成最优路线
- **实时定位**：支持使用当前位置作为起点
- **分段导航**：将规划路线分段，支持跳转到高德地图App进行逐段导航
- **地图可视化**：实时显示规划路线和检查点位置

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          H5前端应用 (index.html)                     │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ script.js │  │  api.js  │  │styles.css│          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └──────────────────────────────────────────────────────┘   │
│                          │                                   │
│                          │ HTTP/REST API                     │
└──────────────────────────┼───────────────────────────────────┘
                           │
┌──────────────────────────┼───────────────────────────────────┐
│                   应用服务层                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │      Flask/Python HTTP Server (license_api.py)       │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │   │
│  │  │ 路由规划   │  │ 许可证查询 │  │ 地点搜索   │     │   │
│  │  │  API模块   │  │  API模块   │  │  API模块   │     │   │
│  │  └────────────┘  └────────────┘  └────────────┘     │   │
│  └──────────────────────────────────────────────────────┘   │
│                          │                                   │
│                          │ SQL                               │
└──────────────────────────┼───────────────────────────────────┘
                           │
┌──────────────────────────┼───────────────────────────────────┐
│                   数据存储层                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          MySQL数据库 (locationnt)                     │   │
│  │  ┌──────────────────────────────────────────────┐    │   │
│  │  │  tobacco_retailers 表                        │    │   │
│  │  │  - 许可证号, 法人姓名, 客户名称              │    │   │
│  │  │  - 经营地址, 经度, 纬度                      │    │   │
│  │  └──────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   第三方服务层                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           高德地图服务                                │   │
│  │  ┌──────────────┐  ┌──────────────┐                  │   │
│  │  │ Web JS API   │  │ Web Service  │                  │   │
│  │  │ (前端地图)   │  │ (后端服务)   │                  │   │
│  │  └──────────────┘  └──────────────┘                  │   │
│  │  - 地图渲染      - 路径规划                           │   │
│  │  - 地点搜索      - IP定位                            │   │
│  │  - 坐标转换      - 地点搜索                           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

#### 前端技术栈
- **HTML5**：页面结构
- **CSS3**：样式与响应式布局
- **JavaScript (ES6+)**：业务逻辑与交互
- **高德地图 JS API v1.4.15**：地图渲染、路线可视化
- **Fetch API**：HTTP请求
- **Geolocation API**：获取用户当前位置

#### 后端技术栈
- **Python 3.x**：主要开发语言
- **Flask / http.server**：HTTP服务器框架
- **pymysql**：MySQL数据库连接
- **urllib**：HTTP客户端（调用高德Web Service API）
- **json**：数据序列化

#### 数据存储
- **MySQL**：关系型数据库，存储企业许可证与位置信息

#### 第三方服务
- **高德地图开放平台**：
  - Web JS API：前端地图服务
  - Web Service API：后端路径规划、地点搜索、IP定位

---

## 3. 模块设计

### 3.1 前端模块

#### 3.1.1 页面结构模块 (`index.html`)
**职责**：定义页面DOM结构，组织UI组件

**主要区域**：
- **许可证搜索区域**：输入框与搜索结果展示
- **任务池区域**：四个分类的任务列表（重点检查、随机抽查、许可核查、日常检查）
- **起点搜索区域**：起点输入、当前位置定位、清除功能
- **路线规划按钮**：触发智能路线规划
- **路线显示区域**：地图容器、路线详情、分段导航按钮

#### 3.1.2 API通信模块 (`api.js`)
**职责**：封装所有与后端API的通信逻辑

**核心函数**：
```javascript
// API基础配置
getApiBaseUrl()              // 自动检测API服务器地址（支持手机访问）

// 数据查询API
getLocationByIP(ip)          // IP定位
searchPlaceByKeyword(keyword, city)  // 地点关键字搜索
searchLicenseInDatabase(licenseNumber)  // 许可证号码搜索

// 任务数据API（Mock数据）
getPriorityInspectionData()  // 获取重点检查任务
getRandomInspectionData()    // 获取随机抽查任务
getPermitInspectionData()   // 获取许可核查任务
getRoutineInspectionData()   // 获取日常检查任务

// 路线规划API
planRouteWithAMap(payload)   // 通过后端调用高德Web Service进行路径规划
```

**设计特点**：
- **自动IP适配**：根据访问域名自动切换API地址，支持本地开发与手机访问
- **统一错误处理**：所有API调用都有try-catch包装，提供友好的错误提示
- **兜底方案**：路径规划失败时使用直线距离作为备选方案

#### 3.1.3 业务逻辑模块 (`script.js`)
**职责**：实现核心业务逻辑、UI交互、地图渲染

**核心功能模块**：

1. **任务管理模块**
   - `loadCategoryData()`：加载各分类任务数据
   - `toggleCategory()`：展开/折叠任务分类
   - `addTaskToRoute()`：将任务添加到路线规划列表
   - `removeTaskFromRoute()`：从路线中移除任务

2. **许可证搜索模块**
   - `searchByLicenseNumber()`：搜索许可证并显示结果
   - `openLicenseSearch()`：打开许可证搜索弹窗

3. **起点管理模块**
   - `searchStartPoint()`：搜索起点位置
   - `locateCurrentStartPoint()`：使用浏览器定位获取当前位置
   - `clearStartPoint()`：清除已设置的起点

4. **路线规划模块**
   - `planRoute()`：主入口，触发智能路线规划
   - `planRouteInternal()`：内部规划逻辑
   - `maybeOptimizeRouteOrderWithAntColony()`：蚁群算法优化点顺序
   - `generateRouteContent()`：生成路线展示内容

5. **蚁群算法模块**（智能排序）
   - `antColonyOptimize(points)`：蚁群算法主函数
   - `buildDistanceMatrix(points)`：构建距离矩阵
   - `evaluateRouteLength(route, distanceMatrix)`：评估路线长度
   - `haversineDistanceKm(point1, point2)`：计算两点间球面距离

6. **地图渲染模块**
   - `initRouteMap()`：初始化高德地图实例
   - `renderRouteOnMap()`：在地图上渲染路线
   - `updateStartPointPreviewMarker()`：显示起点预览标记

7. **导航模块**
   - `navigateSegmentWithAmap(segment)`：跳转到高德App进行分段导航
   - `buildAmapNavigationUrls(segment)`：构建高德URL Scheme

#### 3.1.4 样式模块 (`styles.css`)
**职责**：定义页面样式、响应式布局、动画效果

**设计特点**：
- **响应式设计**：适配PC与移动端
- **模块化样式**：按功能区域组织CSS类
- **交互反馈**：按钮悬停、加载状态等视觉反馈

### 3.2 后端模块

#### 3.2.1 HTTP服务器模块 (`license_api.py`)
**职责**：提供RESTful API服务，处理HTTP请求

**核心类**：
```python
class LicenseRequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):    # 处理GET请求
    def do_POST(self):   # 处理POST请求
    def do_OPTIONS(self): # 处理CORS预检请求
```

**设计特点**：
- **CORS支持**：自动处理跨域请求
- **统一错误处理**：所有异常都有JSON格式的错误响应
- **日志记录**：记录请求路径、参数、错误信息

#### 3.2.2 数据库访问模块
**职责**：封装数据库连接与查询逻辑

**核心函数**：
```python
get_db_connection()                    # 获取数据库连接
detect_retailers_table_name()          # 自动检测表名
search_license_by_number(license_number)  # 许可证搜索
```

**设计特点**：
- **自动表名检测**：自动识别包含必要字段的数据表
- **连接池管理**：每次查询创建新连接，查询后关闭
- **异常处理**：数据库连接失败时返回友好错误信息

#### 3.2.3 高德地图服务集成模块
**职责**：调用高德Web Service API，提供路径规划、地点搜索等功能

**核心函数**：
```python
plan_route_with_amap(points, strategy)  # 路径规划
fetch_route_segment(origin, dest, waypoints, strategy)  # 获取路线段
search_place_by_keyword(keyword, city)  # 地点搜索
get_location_by_ip(ip)                  # IP定位
```

**设计特点**：
- **分段规划策略**：对相邻检查点逐段调用API，确保所有路段都有真实路径
- **策略参数化**：支持不同的路径规划策略（最短距离、最快时间等）
- **Polyline解析**：解析高德返回的编码路径，转换为坐标数组

#### 3.2.4 工具函数模块
**职责**：提供通用工具函数

**核心函数**：
```python
haversine_km(point1, point2)  # 计算两点间球面距离
decode_polyline(polyline_str)  # 解码高德Polyline编码
```

---

## 4. 数据流设计

### 4.1 许可证搜索流程

```
用户输入许可证号
    ↓
前端调用 searchLicenseInDatabase()
    ↓
HTTP GET /api/search/license/{licenseNumber}
    ↓
后端查询MySQL数据库
    ↓
返回JSON: {许可证号, 客户名称, 经营地址, 经度, 纬度}
    ↓
前端显示搜索结果，用户可选择添加到路线
```

### 4.2 智能路线规划流程

```
用户点击"一键智能规划路线"
    ↓
前端收集所有选中的检查点
    ↓
[可选] 蚁群算法优化点顺序
    ↓
前端调用 planRouteWithAMap({points, strategy})
    ↓
HTTP POST /api/plan/route
    ↓
后端对相邻点逐段调用高德路径规划API
    ↓
后端合并所有路径段，返回完整路线
    ↓
前端接收路线数据
    ↓
前端调用高德JS API渲染地图路线
    ↓
前端生成路线详情与分段导航按钮
```

### 4.3 分段导航流程

```
用户点击"打开高德地图导航此段"
    ↓
前端提取该段的起点、终点、途径点
    ↓
前端构建高德URL Scheme
    ↓
Android: androidamap://route/plan/?...
iOS: iosamap://path?...
Web: https://uri.amap.com/navigation?...
    ↓
浏览器跳转到高德地图App
    ↓
高德App打开并开始导航
```

---

## 5. 核心算法

### 5.1 蚁群算法（Ant Colony Optimization）

**应用场景**：智能排序检查点，生成最短路线

**算法流程**：
1. **初始化**：构建距离矩阵，初始化信息素矩阵
2. **迭代过程**：
   - 每只蚂蚁按概率选择下一个未访问点
   - 概率 = (信息素^α) × (启发式信息^β)
   - 启发式信息 = 1 / 距离
3. **更新信息素**：根据路线长度更新信息素浓度
4. **终止条件**：达到最大迭代次数或找到满意解

**参数设置**：
- `alpha = 1.0`：信息素重要程度
- `beta = 2.0`：启发式信息重要程度
- `evaporation = 0.5`：信息素挥发率
- `iterations = 50`：迭代次数
- `ants = 10`：蚂蚁数量

**实现位置**：`script.js` → `antColonyOptimize()`

### 5.2 路径规划策略

**高德地图策略参数**：
- `strategy = '1'`：最短距离（默认）
- `strategy = '0'`：最快时间
- `strategy = '2'`：避开高速
- `strategy = '3'`：不走高速

**分段规划策略**：
- 对N个检查点，生成N-1个路径段
- 每段调用一次高德API，确保所有路段都是真实道路
- 合并所有路径段的Polyline，形成完整路线

---

## 6. 接口设计

### 6.1 后端API接口

#### 6.1.1 许可证搜索
```
GET /api/search/license/{licenseNumber}

响应：
{
  "license_number": "许可证号",
  "customer_name": "客户名称",
  "legal_person": "法人姓名",
  "address": "经营地址",
  "longitude": 120.891467,
  "latitude": 31.974575
}
```

#### 6.1.2 路径规划
```
POST /api/plan/route

请求体：
{
  "points": [
    {
      "name": "起点名称",
      "longitude": 120.891467,
      "latitude": 31.974575
    },
    ...
  ],
  "strategy": "1"  // 可选，默认"1"
}

响应：
{
  "distance": "总距离(km)",
  "duration": "总时长(分钟)",
  "segments": [
    {
      "from": {name, longitude, latitude},
      "to": {name, longitude, latitude},
      "distance": "段距离(km)",
      "duration": "段时长(分钟)",
      "polyline": [[lng, lat], ...]  // 路径坐标数组
    },
    ...
  ]
}
```

#### 6.1.3 地点搜索
```
GET /api/place/search?keyword={keyword}&city={city}

响应：
{
  "pois": [
    {
      "name": "地点名称",
      "address": "详细地址",
      "location": "120.891467,31.974575"
    },
    ...
  ]
}
```

#### 6.1.4 IP定位
```
GET /api/location/ip?ip={ip}

响应：
{
  "province": "省份",
  "city": "城市",
  "adcode": "区域编码",
  "rectangle": "边界坐标"
}
```

### 6.2 前端API函数

所有前端API函数定义在 `api.js` 中，使用 `async/await` 语法，返回Promise对象。

---

## 7. 数据库设计

### 7.1 数据表结构

**表名**：`tobacco_retailers`（自动检测，可能为其他名称）

**字段**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| 许可证号 | VARCHAR | 主键，唯一标识 |
| 法人姓名 | VARCHAR | 企业法人 |
| 客户名称 | VARCHAR | 企业名称 |
| 经营地址 | VARCHAR | 详细地址 |
| 经度 | DECIMAL(10,6) | 经度坐标 |
| 纬度 | DECIMAL(10,6) | 纬度坐标（可能为"维度"） |

**索引**：
- 主键：许可证号
- 建议索引：经度、纬度（用于地理查询优化）

---

## 8. 安全设计

### 8.1 API安全
- **高德API Key保护**：API Key存储在后端，前端不直接调用高德Web Service
- **CORS配置**：后端设置适当的CORS头，限制跨域访问
- **输入验证**：所有用户输入都进行验证和转义

### 8.2 数据安全
- **SQL注入防护**：使用参数化查询（pymysql的参数绑定）
- **敏感信息**：数据库密码等敏感信息存储在配置文件中，不提交到版本控制

---

## 9. 性能优化

### 9.1 前端优化
- **地图懒加载**：路线规划后才初始化地图
- **防抖处理**：搜索输入框添加防抖，减少API调用
- **缓存策略**：任务数据可考虑本地缓存

### 9.2 后端优化
- **数据库连接复用**：考虑使用连接池（当前为每次查询新建连接）
- **API调用优化**：路径规划采用分段调用，避免单次请求过多点
- **响应压缩**：可考虑启用gzip压缩

### 9.3 算法优化
- **蚁群算法参数调优**：根据实际数据量调整迭代次数和蚂蚁数量
- **距离计算缓存**：相同点对的距离计算结果可缓存

---

## 10. 部署架构

### 10.1 开发环境
- **前端**：本地HTTP服务器（Python `http.server` 或 Node.js `serve`）
- **后端**：本地Flask服务器（端口5001）
- **数据库**：本地MySQL实例

### 10.2 生产环境（阿里云部署）

#### 方案A：ECS + Nginx
```
用户请求
    ↓
Nginx (80/443端口)
    ↓
┌─────────────┬──────────────┐
│  静态文件   │  反向代理    │
│  (H5前端)   │  → Flask:5001│
└─────────────┴──────────────┘
    ↓
MySQL数据库
```

#### 方案B：OSS + CDN + ECS
```
用户请求
    ↓
CDN (加速静态资源)
    ↓
OSS (存储H5前端文件)
    ↓
ECS (运行Flask后端)
    ↓
MySQL数据库
```

### 10.3 配置要点
- **HTTPS配置**：生产环境必须使用HTTPS（浏览器定位API要求）
- **域名配置**：配置域名解析，设置CORS白名单
- **防火墙规则**：开放必要端口（80, 443, 5001）
- **进程管理**：使用supervisor或systemd管理Flask进程

---

## 11. 扩展性设计

### 11.1 功能扩展
- **多用户支持**：添加用户认证，支持多用户任务管理
- **历史路线**：保存历史规划路线，支持路线对比
- **实时交通**：集成实时交通数据，动态调整路线
- **任务调度**：支持定时任务、批量导入

### 11.2 技术扩展
- **前端框架**：可迁移到Vue/React等现代框架
- **后端框架**：可升级到Flask-RESTful或FastAPI
- **数据库扩展**：支持PostgreSQL、MongoDB等
- **缓存层**：引入Redis缓存热点数据

---

## 12. 故障处理

### 12.1 前端故障
- **API调用失败**：显示友好错误提示，提供重试机制
- **地图加载失败**：检查高德API Key配置，检查网络连接
- **定位失败**：提示用户检查浏览器权限，提供手动输入选项

### 12.2 后端故障
- **数据库连接失败**：记录日志，返回503错误
- **高德API调用失败**：使用兜底方案（直线距离），记录错误日志
- **服务崩溃**：使用进程管理工具自动重启

### 12.3 监控与日志
- **访问日志**：记录所有API请求
- **错误日志**：记录异常堆栈信息
- **性能监控**：监控API响应时间、数据库查询时间

---

## 13. 开发规范

### 13.1 代码规范
- **JavaScript**：使用ES6+语法，遵循ESLint规则
- **Python**：遵循PEP 8规范，使用类型提示
- **注释**：关键函数和复杂逻辑必须添加注释

### 13.2 版本控制
- **Git工作流**：使用分支开发，主分支保持稳定
- **提交信息**：使用清晰的提交信息，说明修改内容

### 13.3 测试
- **单元测试**：核心算法（如蚁群算法）应有单元测试
- **集成测试**：API接口应有集成测试
- **端到端测试**：关键业务流程应有E2E测试

---

## 14. 总结

本系统采用前后端分离架构，前端负责用户交互与地图可视化，后端提供数据服务与路径规划能力。通过整合高德地图服务与MySQL数据库，实现了智能路线规划的核心功能。系统设计注重可扩展性与可维护性，为后续功能扩展预留了空间。

**核心优势**：
- ✅ 前后端分离，职责清晰
- ✅ 自动IP适配，支持多端访问
- ✅ 智能算法优化，提升路线效率
- ✅ 分段导航，解决高德App限制
- ✅ 兜底方案，保证系统稳定性

**技术亮点**：
- 🎯 蚁群算法实现智能排序
- 🎯 分段路径规划确保路线真实
- 🎯 URL Scheme实现App跳转导航
- 🎯 自动表名检测提升兼容性

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护人员**：开发团队





